<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Reminder System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f7;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .panel h2 {
            margin-top: 0;
            color: #1d1d1f;
            border-bottom: 2px solid #007aff;
            padding-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .messages {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Monaco', monospace;
            font-size: 12px;
        }
        .message {
            margin: 5px 0;
            padding: 5px 8px;
            border-radius: 4px;
        }
        .message.user { background: #e3f2fd; border-left: 3px solid #2196f3; }
        .message.caregiver { background: #fff3e0; border-left: 3px solid #ff9800; }
        .message.system { background: #f3e5f5; border-left: 3px solid #9c27b0; }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #0056cc; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #ff3b30; }
        button.danger:hover { background: #d70015; }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            margin: 5px 0;
        }
        .analytics {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            grid-column: 1 / -1;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007aff;
        }
        .stat-label {
            font-size: 12px;
            color: #8e8e93;
            margin-top: 5px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #1d1d1f;
            margin-bottom: 10px;
        }
        .header p {
            color: #86868b;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß† Real-Time Reminder System</h1>
        <p>Test interface for context-aware smart reminders with live WebSocket connections</p>
    </div>

    <div class="container">
        <!-- User Panel -->
        <div class="panel">
            <h2>üë§ Patient Interface</h2>
            <div>
                Status: <span id="userStatus" class="status disconnected">Disconnected</span>
            </div>
            
            <div class="controls">
                <button onclick="connectUser()">Connect</button>
                <button onclick="disconnectUser()" class="danger">Disconnect</button>
                <button onclick="requestStatus()">Request Status</button>
            </div>

            <div>
                <h4>Send Response to Reminder</h4>
                <input id="reminderIdInput" placeholder="Reminder ID (e.g., rem_123)" value="test_reminder_123">
                <textarea id="responseInput" placeholder="Your response to the reminder..." rows="3">Yes, I took my medication</textarea>
                <button onclick="sendResponse()">Send Response</button>
            </div>

            <div class="messages" id="userMessages"></div>
        </div>

        <!-- Caregiver Panel -->
        <div class="panel">
            <h2>üë®‚Äç‚öïÔ∏è Caregiver Interface</h2>
            <div>
                Status: <span id="caregiverStatus" class="status disconnected">Disconnected</span>
            </div>
            
            <div class="controls">
                <button onclick="connectCaregiver()">Connect</button>
                <button onclick="disconnectCaregiver()" class="danger">Disconnect</button>
                <button onclick="getUserStatus()">Get Patient Status</button>
            </div>

            <div>
                <h4>Alert Actions</h4>
                <input id="alertIdInput" placeholder="Alert ID" value="alert_123">
                <div style="display: flex; gap: 10px;">
                    <button onclick="acknowledgeAlert()">Acknowledge Alert</button>
                    <button onclick="resolveAlert()">Resolve Alert</button>
                </div>
            </div>

            <div class="messages" id="caregiverMessages"></div>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div class="analytics">
        <h2>üìä System Analytics</h2>
        <button onclick="refreshAnalytics()">Refresh Analytics</button>
        
        <div class="stat-grid">
            <div class="stat">
                <div class="stat-value" id="activeConnections">0</div>
                <div class="stat-label">Active Connections</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="userConnections">0</div>
                <div class="stat-label">Patient Connections</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="caregiverConnections">0</div>
                <div class="stat-label">Caregiver Connections</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="engineStatus">‚ùì</div>
                <div class="stat-label">Engine Status</div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connections
        let userWs = null;
        let caregiverWs = null;
        
        // Configuration
        const WS_BASE_URL = 'ws://localhost:8000/ws';
        const API_BASE_URL = 'http://localhost:8000';
        const USER_ID = 'test_user_123';
        const CAREGIVER_ID = 'test_caregiver_456';

        // User WebSocket functions
        function connectUser() {
            if (userWs) {
                addMessage('user', 'Already connected');
                return;
            }

            userWs = new WebSocket(`${WS_BASE_URL}/user/${USER_ID}`);
            
            userWs.onopen = () => {
                updateUserStatus(true);
                addMessage('user', '‚úÖ Connected to reminder system');
            };
            
            userWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage('user', `üì® ${data.type}: ${data.message || JSON.stringify(data)}`);
            };
            
            userWs.onclose = () => {
                updateUserStatus(false);
                addMessage('user', '‚ùå Disconnected from system');
                userWs = null;
            };
            
            userWs.onerror = (error) => {
                addMessage('user', `üö® Connection error: ${error}`);
            };
        }

        function disconnectUser() {
            if (userWs) {
                userWs.close();
            }
        }

        function requestStatus() {
            if (!userWs) {
                addMessage('user', '‚ùå Not connected');
                return;
            }
            
            userWs.send(JSON.stringify({
                type: 'status_request',
                timestamp: new Date().toISOString()
            }));
        }

        function sendResponse() {
            if (!userWs) {
                addMessage('user', '‚ùå Not connected');
                return;
            }
            
            const reminderId = document.getElementById('reminderIdInput').value;
            const responseText = document.getElementById('responseInput').value;
            
            if (!reminderId || !responseText) {
                addMessage('user', '‚ùå Please fill in reminder ID and response');
                return;
            }
            
            userWs.send(JSON.stringify({
                type: 'reminder_response',
                reminder_id: reminderId,
                response_text: responseText,
                response_time_seconds: Math.random() * 60 + 10 // 10-70 seconds
            }));
            
            addMessage('user', `üì§ Sent response: "${responseText}"`);
        }

        // Caregiver WebSocket functions
        function connectCaregiver() {
            if (caregiverWs) {
                addMessage('caregiver', 'Already connected');
                return;
            }

            caregiverWs = new WebSocket(`${WS_BASE_URL}/caregiver/${CAREGIVER_ID}`);
            
            caregiverWs.onopen = () => {
                updateCaregiverStatus(true);
                addMessage('caregiver', '‚úÖ Connected to alert system');
            };
            
            caregiverWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                addMessage('caregiver', `üö® ${data.type}: ${data.message || JSON.stringify(data)}`);
            };
            
            caregiverWs.onclose = () => {
                updateCaregiverStatus(false);
                addMessage('caregiver', '‚ùå Disconnected from system');
                caregiverWs = null;
            };
            
            caregiverWs.onerror = (error) => {
                addMessage('caregiver', `üö® Connection error: ${error}`);
            };
        }

        function disconnectCaregiver() {
            if (caregiverWs) {
                caregiverWs.close();
            }
        }

        function getUserStatus() {
            if (!caregiverWs) {
                addMessage('caregiver', '‚ùå Not connected');
                return;
            }
            
            caregiverWs.send(JSON.stringify({
                type: 'request_user_status',
                user_id: USER_ID,
                timestamp: new Date().toISOString()
            }));
        }

        function acknowledgeAlert() {
            if (!caregiverWs) {
                addMessage('caregiver', '‚ùå Not connected');
                return;
            }
            
            const alertId = document.getElementById('alertIdInput').value;
            if (!alertId) {
                addMessage('caregiver', '‚ùå Please enter alert ID');
                return;
            }
            
            caregiverWs.send(JSON.stringify({
                type: 'acknowledge_alert',
                alert_id: alertId,
                caregiver_id: CAREGIVER_ID,
                timestamp: new Date().toISOString()
            }));
            
            addMessage('caregiver', `‚úÖ Acknowledged alert: ${alertId}`);
        }

        function resolveAlert() {
            if (!caregiverWs) {
                addMessage('caregiver', '‚ùå Not connected');
                return;
            }
            
            const alertId = document.getElementById('alertIdInput').value;
            if (!alertId) {
                addMessage('caregiver', '‚ùå Please enter alert ID');
                return;
            }
            
            caregiverWs.send(JSON.stringify({
                type: 'resolve_alert',
                alert_id: alertId,
                caregiver_id: CAREGIVER_ID,
                resolution_notes: 'Resolved via web interface',
                timestamp: new Date().toISOString()
            }));
            
            addMessage('caregiver', `‚úÖ Resolved alert: ${alertId}`);
        }

        // Analytics functions
        async function refreshAnalytics() {
            try {
                const response = await fetch(`${API_BASE_URL}/ws/status`);
                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('activeConnections').textContent = 
                        data.active_user_connections + data.active_caregiver_connections;
                    document.getElementById('userConnections').textContent = data.active_user_connections;
                    document.getElementById('caregiverConnections').textContent = data.active_caregiver_connections;
                    document.getElementById('engineStatus').textContent = data.engine_running ? '‚úÖ' : '‚ùå';
                    
                    addMessage('system', `üìä Analytics updated: ${JSON.stringify(data)}`);
                } else {
                    addMessage('system', '‚ùå Failed to fetch analytics');
                }
            } catch (error) {
                addMessage('system', `‚ùå Analytics error: ${error.message}`);
            }
        }

        // Helper functions
        function updateUserStatus(connected) {
            const statusEl = document.getElementById('userStatus');
            statusEl.textContent = connected ? 'Connected' : 'Disconnected';
            statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function updateCaregiverStatus(connected) {
            const statusEl = document.getElementById('caregiverStatus');
            statusEl.textContent = connected ? 'Connected' : 'Disconnected';
            statusEl.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }

        function addMessage(type, message) {
            const messagesEl = document.getElementById(`${type}Messages`) || document.getElementById('userMessages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageEl.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addMessage('system', 'üöÄ Web interface loaded. Make sure the API server is running on localhost:8000');
            refreshAnalytics();
        });

        // Auto-refresh analytics every 30 seconds
        setInterval(refreshAnalytics, 30000);
    </script>
</body>
</html>